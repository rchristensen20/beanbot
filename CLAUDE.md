# CLAUDE.md

## Project Overview

Farmbot is a personal gardening assistant Discord bot for a small farm in Colorado (Zone 5b, Mountain Time). It uses a LangGraph agentic workflow backed by Google Vertex AI (Gemini) to manage a markdown-based knowledge library, task list, harvest log, and garden journal.

## Tech Stack

- **Python 3.13** with discord.py, LangGraph, langchain-google-vertexai, pymupdf
- **Google Vertex AI** (Gemini 2.5 Flash) for LLM inference
- **LangGraph** state machine with tool-calling loop and SQLite checkpointer for conversation memory
- **Docker** for deployment (single container, `docker-compose up`)

## Architecture

```
src/bot.py       → Discord bot: message routing, commands, scheduled crons, UI components
src/graph.py     → LangGraph state machine: agent node ↔ tool node loop, system prompt, checkpointer
src/services/tools.py → Pure functions: file I/O, task management, harvest logging, calendar generation
data/            → Markdown knowledge library (auto-managed by the bot)
```

### Key patterns

- **Channel-based routing** — `on_message` checks channel ID to determine context (journal, questions, knowledge_ingest, DM). Context string is prepended to the HumanMessage, not stored as a separate SystemMessage.
- **PDF ingestion** — PDF attachments in the knowledge_ingest channel are detected by content type or `.pdf` extension, text-extracted via `pymupdf`, and fed into the same ingestion pipeline as URL/text content. Scanned PDFs without a text layer will yield empty results (no OCR).
- **LLM processes everything** — Rather than rigid parsing, structured user input (like debrief forms) is sent as a prompt to the LangGraph agent. The agent decides which tools to call.
- **Persistent Discord views** — `discord.ui.View(timeout=None)` with `custom_id` on buttons, registered in `setup_hook` via `self.add_view()` so they survive bot restarts.
- **Ephemeral thread IDs** — Scheduled tasks (daily report, debrief) use date-based thread IDs like `daily_report_2025-06-15` so they don't accumulate conversation history across days.

## File Conventions

- Knowledge files live in `data/` as markdown (one file per topic, e.g. `garlic.md`)
- Special files: `tasks.md` (todo list with `- [ ]`/`- [x]` checkboxes), `harvests.md` (markdown table), `garden_log.md` (timestamped log entries), `planting_calendar.md` (auto-generated), `almanac.md`, `farm_layout.md`, `categories.md` (auto-generated by `!consolidate`)
- Daily briefing snapshots: `data/daily_YYYY-MM-DD.md`
- Consolidation backups: `data/backups/<filename>.<timestamp>.bak`
- SQLite conversation DB: `data/conversations.db`

## Commands

- `!briefing` — Manual trigger for the morning briefing (reminders or journal channel)
- `!debrief` — Manual trigger for the evening debrief prompt (journal channel only)
- `!consolidate <topic>` — Find all files related to a topic, back them up, merge/deduplicate into a single clean file, and delete merged sub-files (questions, reminders, or journal channel)
- `!consolidate` (no args) — LLM-based semantic categorization: sends all filenames to Gemini in batches, groups them by plant type (Trees, Herbs, Vegetables, etc.), identifies merge candidates, saves results to `categories.md`, and posts a summary to Discord. Falls back to prefix-based grouping on LLM failure.
- `!recap [days]` — Generate a recap of the last N days (default 7, max 90) of garden activity. Summarizes journal entries, harvests, and task progress. Works in reminders, journal, or questions channel.

## Scheduled Tasks

- **8:00 AM MT** — `daily_report`: morning briefing with current weather, 48-hour forecast, tasks, planting calendar → reminders channel. Includes frost/rain-based watering and protection advice.
- **8:00 PM MT** — `daily_debrief`: evening debrief prompt with open tasks + button → journal channel
- **Every 6 hours** — `weather_alerts`: checks 48-hour forecast for frost (≤ 2°C) or significant rain (≥ 60% chance or ≥ 10mm). Posts alert to reminders channel, max once per day (deduped via `data/.alert_flag`).
- **Sunday 8:00 PM MT** — `weekly_recap`: automatic 7-day garden recap → reminders channel

## Environment Variables

Required in `.env` (or Docker environment):
- `DISCORD_TOKEN`, `REMINDERS_CHANNEL_ID`, `JOURNAL_CHANNEL_ID`, `QUESTIONS_CHANNEL_ID`, `KNOWLEDGE_INGEST_CHANNEL_ID`
- `GCP_PROJECT`, `GCP_LOCATION`, `VERTEX_MODEL`
- `OPENWEATHER_API_KEY`, `WEATHER_LAT`, `WEATHER_LON`

Google Cloud credentials go in `privatecredentials/credentials.json`.

## Development

```bash
# Run locally (needs .env and credentials)
python -m src.bot

# Run with Docker
docker-compose up --build -d

# View logs
docker-compose logs -f
```

## Adding New Tools

1. Write the pure function in `src/services/tools.py`
2. Create a `@tool`-decorated wrapper in `src/graph.py`
3. Add it to the `TOOLS` list in `src/graph.py`
4. Mention it in `STATIC_SYSTEM_PROMPT` so the agent knows when to use it

## Things to Watch Out For

- `tool_overwrite_file` replaces entire file contents — the agent uses this for tasks.md updates (checking boxes). If the agent hallucinates content, the file gets corrupted. The system prompt warns it to use caution.
- The `trim_messages_for_context` function in `graph.py` keeps only the last 10 conversation turns to prevent context window overflow.
- All file operations in `tools.py` use `os.path.basename()` to prevent directory traversal.
- `tool_delete_file` has a hardcoded `SYSTEM_FILES` set preventing deletion of core files (`tasks.md`, `harvests.md`, `garden_log.md`, `planting_calendar.md`, `almanac.md`, `farm_layout.md`, `categories.md`).
- `!consolidate` always backs up files before modifying/deleting. Backups live in `data/backups/`.
- `categorize_files()` and `suggest_merges()` in `graph.py` are direct LLM calls (no agent/tools) using `ChatVertexAI` without `.bind_tools()`. They batch files in groups of ~200 to avoid output token limits.
- The system prompt maps "categories" questions to `categories.md` to prevent Gemini from hallucinating file lists from memory.
