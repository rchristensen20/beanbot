# CLAUDE.md

## Project Overview

Beanbot is a personal gardening assistant Discord bot. It uses a LangGraph agentic workflow backed by the Google Gemini API to manage a markdown-based knowledge library, task list, harvest log, and garden journal.

## Tech Stack

- **Python 3.13** with discord.py, LangGraph, langchain-google-genai, pymupdf
- **Google Gemini API** (Gemini 2.5 Flash) for LLM inference
- **LangGraph** state machine with tool-calling loop and SQLite checkpointer for conversation memory
- **Docker** for deployment (single container, `docker-compose up`)

## Architecture

```
src/bot.py                      → Discord bot: message routing, commands, scheduled crons, UI components
src/graph.py                    → LangGraph state machine: agent node ↔ tool node loop, system prompt, checkpointer
src/services/tools.py           → Pure functions: file I/O, task management, harvest logging, calendar generation, member registry
src/services/weather.py         → Standalone async weather/forecast fetchers (OpenWeatherMap API)
src/services/categorization.py  → LLM-based file categorization and merge suggestion (used by !consolidate)
data/                           → Markdown knowledge library (auto-managed by the bot)
```

### Key patterns

- **Channel-based routing** — `on_message` checks channel ID to determine context (journal, questions, knowledge_ingest, DM). Context strings are defined in the `CHANNEL_CONTEXT` dict at the top of `bot.py` and prepended to the HumanMessage, not stored as a separate SystemMessage.
- **PDF ingestion** — PDF attachments in the knowledge_ingest channel are detected by content type or `.pdf` extension, text-extracted via `pymupdf`, and fed into the same ingestion pipeline as URL/text content. Scanned PDFs without a text layer will yield empty results (no OCR).
- **LLM processes everything** — Rather than rigid parsing, structured user input (like debrief forms) is sent as a prompt to the LangGraph agent. The agent decides which tools to call.
- **Persistent Discord views** — `discord.ui.View(timeout=None)` with `custom_id` on buttons, registered in `setup_hook` via `self.add_view()` so they survive bot restarts.
- **Ephemeral thread IDs** — Scheduled tasks (daily report, debrief) use date-based thread IDs like `daily_report_2025-06-15` so they don't accumulate conversation history across days.

## File Conventions

- Knowledge files live in `data/` as markdown (one file per topic, e.g. `garlic.md`)
- Special files: `tasks.md` (todo list with `- [ ]`/`- [x]` checkboxes), `harvests.md` (markdown table), `garden_log.md` (timestamped log entries), `planting_calendar.md` (auto-generated), `almanac.md`, `farm_layout.md`, `categories.md` (auto-generated by `!consolidate`), `members.json` (member registry, auto-created by `!register`)
- Daily briefing snapshots: `data/daily_YYYY-MM-DD.md`
- Consolidation backups: `data/backups/<filename>.<timestamp>.bak`
- SQLite conversation DB: `data/conversations.db`

## Commands

- `!briefing` — Manual trigger for the morning briefing (reminders or journal channel). Shows "Nothing urgent today — all clear!" when there's nothing to report. When members are registered, groups tasks by assignee and injects @mentions.
- `!debrief` — Manual trigger for the evening debrief prompt (journal channel only). Shows calling user's assigned tasks + unassigned tasks (if registered), or all open tasks otherwise.
- `!consolidate <topic>` — Find all files related to a topic, back them up, merge/deduplicate into a single clean file, and delete merged sub-files (questions, reminders, or journal channel)
- `!consolidate` (no args) — LLM-based semantic categorization: sends all filenames to Gemini in batches, groups them by plant type (Trees, Herbs, Vegetables, etc.), identifies merge candidates, saves results to `categories.md`, and posts a summary to Discord. Falls back to prefix-based grouping on LLM failure.
- `!recap [days]` — Generate a recap of the last N days (default 7, max 90) of garden activity. Summarizes journal entries, harvests, and task progress. Works in reminders, journal, or questions channel.
- `!setup` — Start onboarding flow. Redirects to DMs if called from a channel. Walks user through location/zone, garden layout, knowledge building, and channel orientation. Skips if already complete.
- `!register <name>` — Register the calling user as a named garden member. Creates/updates `data/members.json`.
- `!register <name> @user` — Register a mentioned user as a named member (admin use).
- `!members` — List all registered garden members with Discord @mentions.
- `!commands` — Show a help message listing all commands with brief usage.
- `!version` — Show the current Beanbot version (parsed from `pyproject.toml` at import time).

## Scheduled Tasks

- **8:00 AM** — `daily_report`: morning briefing with current weather, 48-hour forecast, tasks, planting calendar → reminders channel. Includes frost/rain-based watering and protection advice. When members are registered, tasks are grouped by assignee and names are replaced with @mentions.
- **8:00 PM** — `daily_debrief`: evening debrief prompt with all open tasks + button → journal channel
- **Every 6 hours** — `weather_alerts`: checks 48-hour forecast for frost (≤ 2°C) or significant rain (≥ 60% chance or ≥ 10mm). Posts alert to reminders channel, max once per day (deduped via `data/.alert_flag`).
- **Sunday 8:00 PM** — `weekly_recap`: automatic 7-day garden recap → reminders channel

## Environment Variables

Required in `.env` (or Docker environment):
- `DISCORD_TOKEN`, `REMINDERS_CHANNEL_ID`, `JOURNAL_CHANNEL_ID`, `QUESTIONS_CHANNEL_ID`, `KNOWLEDGE_INGEST_CHANNEL_ID`
- `GOOGLE_API_KEY`, `GEMINI_MODEL`
- `OPENWEATHER_API_KEY`, `WEATHER_LAT`, `WEATHER_LON`
- `BOT_TIMEZONE` (optional, default: `America/Denver`)

## Development

**IMPORTANT: Always use `uv run` to run Python tools and scripts in this project.** Do not use bare `python`, `python3`, or `pip` — this project uses `uv` for dependency management and all commands should go through it.

```bash
# Run locally (needs .env)
uv run python -m src.bot

# Run with Docker
docker-compose up --build -d

# View logs
docker-compose logs -f

# Bump version (creates commit + tag)
uv run bump-my-version bump patch|minor|major
```

## Adding New Tools

1. Write the pure function in `src/services/tools.py`
2. Create a `@tool`-decorated wrapper in `src/graph.py`
3. Add it to the `TOOLS` list in `src/graph.py`
4. Mention it in `STATIC_SYSTEM_PROMPT` so the agent knows when to use it

## Things to Watch Out For

- `tool_overwrite_file` replaces entire file contents — the agent uses this for tasks.md updates (checking boxes). If the agent hallucinates content, the file gets corrupted. The system prompt warns it to use caution.
- The `trim_messages_for_context` function in `graph.py` keeps only the last 10 conversation turns to prevent context window overflow.
- All file operations in `tools.py` use `os.path.basename()` to prevent directory traversal.
- `SYSTEM_FILES` is defined once at the top of `tools.py` and used by `tool_delete_file` (prevents deletion), `_list_md_paths` (excludes from search/calendar/library listings), and `generate_calendar_from_library` (skips during scan).
- `!consolidate` always backs up files before modifying/deleting. Backups live in `data/backups/`.
- `categorize_files()` and `suggest_merges()` in `src/services/categorization.py` are direct LLM calls (no agent/tools) using `ChatGoogleGenerativeAI` without `.bind_tools()`. They batch files in groups of ~200 to avoid output token limits.
- `fetch_current_weather()` and `fetch_forecast()` in `src/services/weather.py` are standalone async functions with explicit parameters. Weather threshold constants (`FROST_THRESHOLD_C`, `RAIN_PROB_THRESHOLD_PCT`, `RAIN_MM_THRESHOLD`) are defined there.
- `_sanitize_topic()` and `_list_md_paths()` in `tools.py` are shared helpers used by multiple tool functions to avoid duplication.
- `bot.py` constants: `DISCORD_MESSAGE_LIMIT` (2000) and `INGESTION_CHUNK_SIZE` (50,000) control text chunking via `_chunk_text()`. Both `_send_long_reply()` and `run_recap_logic()` delegate to `_chunk_text()`.
- The system prompt maps "categories" questions to `categories.md` to prevent Gemini from hallucinating file lists from memory.
- **Onboarding detection**: `is_onboarding_complete()` in `tools.py` checks if `data/almanac.md` exists. When incomplete, DMs route through the `"onboarding"` channel context instead of `"dm"`. The `!setup` command initiates onboarding, redirecting to DMs if called from a channel.
- **Member registry & task assignment**: `data/members.json` stores `{lowercase_name: discord_id}` mappings. `register_member()` / `list_members()` / `get_member_name_by_discord_id()` in `tools.py` manage it. Tasks can have an `[Assigned: Name]` tag between description and `[Due:]`. `get_tasks_for_user(name)` returns tasks assigned to that user + unassigned tasks, excluding tasks assigned to others. `_inject_mentions()` in `bot.py` replaces registered names with `<@id>` Discord mentions in daily briefing output only. The `[User: Name]` prefix is injected into message content in `on_message` for registered users so the LLM knows who's asking. `members.json` is `.json`, not `.md`, so it's already ignored by `_list_md_paths` and `delete_knowledge_file`.
- **Version**: `_read_version()` in `bot.py` parses version from `pyproject.toml` at import time, cached as `BOT_VERSION`. Use `uv run bump-my-version bump patch|minor|major` to release (updates `pyproject.toml` + `CHANGELOG.md`, creates commit + tag).
